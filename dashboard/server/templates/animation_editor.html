<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-Kart Platform - Animation Editor</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .animation-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .animation-preview {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 380px;
        }
        .led-strip-container {
            background-color: #121212;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 10px;
            overflow: auto;
            max-height: 500px;
        }
        .led-strip {
            display: flex;
            margin-bottom: 4px;
            height: 30px;
        }
        .led {
            width: 20px;
            height: 20px;
            margin: 0 2px;
            border-radius: 50%;
            background-color: #333;
            transition: background-color 0.2s;
        }
        .editor-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .animation-editor {
            flex: 1;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
        }
        .color-picker {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
        }
        .custom-animation {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dimension-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .slider-container .slider-value {
            text-align: center;
            font-weight: bold;
        }
        .nav-link {
            display: inline-block;
            padding: 10px 15px;
            background-color: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .nav-link:hover {
            background-color: #444;
        }
        #json-export {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            color: #f0f0f0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
        }
        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .controls button:hover {
            background-color: #2980b9;
        }
        .tab-container {
            margin-top: 10px;
        }
        .tab-buttons {
            display: flex;
            gap: 5px;
        }
        .tab-button {
            background-color: #333;
            border: 1px solid #555;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 8px 15px;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #1e1e1e;
            border-bottom: 1px solid #1e1e1e;
            position: relative;
            top: 1px;
        }
        .tab-content {
            border: 1px solid #555;
            border-radius: 0 4px 4px 4px;
            padding: 15px;
            background-color: #1e1e1e;
        }
        #send-to-kart-btn {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        #send-to-kart-btn:hover {
            background-color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">← Back to Dashboard</a>
        
        <h1>Go-Kart Animation Editor</h1>
        <p>Create, preview, and save animations for the LED strips on your go-kart. Test animations side-by-side and send them to the kart.</p>
        
        <div class="animation-container" id="animation-container">
            <!-- Animation previews will be added here -->
        </div>
        
        <button id="add-animation" style="width: 200px; margin-bottom: 20px">+ Add Animation</button>
        
        <div class="editor-container">
            <div class="animation-editor">
                <h2>Animation Editor</h2>
                <div class="custom-animation">
                    <label for="animation-name">Animation Name:</label>
                    <input type="text" id="animation-name" placeholder="My Custom Animation">
                    
                    <label for="animation-type">Animation Type:</label>
                    <select id="animation-type">
                        <option value="chase">Chase</option>
                        <option value="pulse">Pulse</option>
                        <option value="rainbow">Rainbow</option>
                        <option value="wipe">Color Wipe</option>
                        <option value="custom">Custom (JSON)</option>
                    </select>
                    
                    <div class="dimension-controls">
                        <div class="slider-container">
                            <label for="strip-length">Strip Length:</label>
                            <input type="range" id="strip-length" min="10" max="300" value="60" step="1">
                            <div class="slider-value" id="strip-length-value">60 LEDs</div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="strip-height">Strip Height:</label>
                            <input type="range" id="strip-height" min="1" max="20" value="1" step="1">
                            <div class="slider-value" id="strip-height-value">1 Row</div>
                        </div>
                    </div>
                    
                    <div id="animation-params">
                        <label for="animation-speed">Speed (ms):</label>
                        <input type="number" id="animation-speed" value="100" min="10" max="2000">
                        
                        <label for="animation-direction">Direction:</label>
                        <select id="animation-direction">
                            <option value="forward">Forward</option>
                            <option value="backward">Backward</option>
                            <option value="bounce">Bounce</option>
                        </select>
                        
                        <div class="color-selection">
                            <label>Colors:</label>
                            <div class="color-picker" id="color-picker">
                                <div class="color-option" style="background-color: #ff0000" data-color="#ff0000"></div>
                                <div class="color-option" style="background-color: #00ff00" data-color="#00ff00"></div>
                                <div class="color-option" style="background-color: #0000ff" data-color="#0000ff"></div>
                                <div class="color-option" style="background-color: #ffff00" data-color="#ffff00"></div>
                                <div class="color-option" style="background-color: #ff00ff" data-color="#ff00ff"></div>
                                <div class="color-option" style="background-color: #00ffff" data-color="#00ffff"></div>
                                <div class="color-option" style="background-color: #ffffff" data-color="#ffffff"></div>
                                <input type="color" id="custom-color" value="#ff0000">
                            </div>
                            <div id="selected-colors"></div>
                        </div>
                    </div>
                    
                    <div id="custom-json-container" style="display: none;">
                        <label for="custom-json">Custom Animation JSON:</label>
                        <textarea id="custom-json" placeholder='{ "frames": [ { "leds": [ { "x": 0, "y": 0, "color": "#ff0000" } ] } ] }'></textarea>
                    </div>
                    
                    <div class="controls">
                        <button id="save-animation">Save Animation</button>
                        <button id="apply-animation" data-editing-id="">Apply Changes</button>
                    </div>
                </div>
            </div>
            
            <div class="animation-editor">
                <h2>Export & Deploy</h2>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <div class="tab-button active" data-tab="export">Export</div>
                        <div class="tab-button" data-tab="deploy">Deploy to Kart</div>
                    </div>
                    
                    <div class="tab-content" id="export-tab">
                        <label for="json-export">Animation JSON:</label>
                        <textarea id="json-export" readonly></textarea>
                        <button id="copy-json" style="margin-top: 10px;">Copy to Clipboard</button>
                        <button id="download-json" style="margin-top: 10px;">Download JSON</button>
                    </div>
                    
                    <div class="tab-content" id="deploy-tab" style="display: none;">
                        <h3>Send Animation to Go-Kart</h3>
                        <p>Select an animation to send to the go-kart:</p>
                        
                        <label for="deploy-animation">Animation:</label>
                        <select id="deploy-animation"></select>
                        
                        <button id="send-to-kart-btn">Send to Go-Kart</button>
                        <div id="deploy-status" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let animations = [];
        let animationPreviews = {};
        let selectedColors = ['#ff0000'];
        
        // Initialize the editor when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('add-animation').addEventListener('click', addNewAnimationPreview);
            document.getElementById('save-animation').addEventListener('click', saveAnimation);
            document.getElementById('apply-animation').addEventListener('click', applyAnimation);
            document.getElementById('animation-type').addEventListener('change', toggleCustomJson);
            document.getElementById('copy-json').addEventListener('click', copyJsonToClipboard);
            document.getElementById('download-json').addEventListener('click', downloadJson);
            document.getElementById('send-to-kart-btn').addEventListener('click', sendAnimationToKart);
            
            // Set up dimension sliders
            const stripLengthSlider = document.getElementById('strip-length');
            const stripLengthValue = document.getElementById('strip-length-value');
            stripLengthSlider.addEventListener('input', function() {
                stripLengthValue.textContent = `${this.value} LEDs`;
            });
            
            const stripHeightSlider = document.getElementById('strip-height');
            const stripHeightValue = document.getElementById('strip-height-value');
            stripHeightSlider.addEventListener('input', function() {
                stripHeightValue.textContent = this.value > 1 ? `${this.value} Rows` : `${this.value} Row`;
            });
            
            // Set up color picker
            const colorPicker = document.getElementById('color-picker');
            const colorOptions = colorPicker.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    addSelectedColor(color);
                });
            });
            
            // Set up custom color picker
            const customColorPicker = document.getElementById('custom-color');
            customColorPicker.addEventListener('change', function() {
                addSelectedColor(this.value);
            });
            
            // Set up tab switching
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Activate the clicked tab
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).style.display = 'block';
                });
            });
            
            // Load animations from server
            loadAnimations();
        });
        
        function addNewAnimationPreview() {
            const container = document.getElementById('animation-container');
            const id = `animation-${Date.now()}`;
            const length = parseInt(document.getElementById('strip-length').value);
            const height = parseInt(document.getElementById('strip-height').value);
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'animation-preview';
            previewDiv.id = id;
            
            let stripHTML = '<div class="led-strip-container">';
            
            for (let y = 0; y < height; y++) {
                stripHTML += '<div class="led-strip">';
                for (let x = 0; x < length; x++) {
                    stripHTML += '<div class="led"></div>';
                }
                stripHTML += '</div>';
            }
            
            stripHTML += '</div>';
            
            previewDiv.innerHTML = `
                <h3>Animation Preview</h3>
                ${stripHTML}
                <div class="controls">
                    <button class="play-pause">Play</button>
                    <button class="edit">Edit</button>
                    <button class="remove">Remove</button>
                </div>
            `;
            
            container.appendChild(previewDiv);
            
            // Set up the LED strip with the default animation
            const animation = {
                name: `Animation ${container.children.length}`,
                type: 'chase',
                speed: 100,
                direction: 'forward',
                colors: ['#ff0000'],
                dimensions: {
                    length: length,
                    height: height
                },
                isPlaying: false,
                interval: null
            };
            
            animations.push(animation);
            animationPreviews[id] = animation;
            
            // Set up event listeners for this preview
            const playPauseBtn = previewDiv.querySelector('.play-pause');
            playPauseBtn.addEventListener('click', function() {
                if (animation.isPlaying) {
                    stopAnimation(id);
                    this.textContent = 'Play';
                } else {
                    startAnimation(id);
                    this.textContent = 'Pause';
                }
            });
            
            previewDiv.querySelector('.edit').addEventListener('click', function() {
                selectAnimationForEditing(id);
            });
            
            previewDiv.querySelector('.remove').addEventListener('click', function() {
                stopAnimation(id);
                previewDiv.remove();
                delete animationPreviews[id];
                animations = animations.filter(a => a !== animation);
                updateJsonExport();
            });
            
            // Update the JSON export
            updateJsonExport();
            updateDeployDropdown();
        }
        
        function startAnimation(id) {
            const animation = animationPreviews[id];
            if (!animation) return;
            
            const previewDiv = document.getElementById(id);
            if (!previewDiv) return;
            
            const ledStrips = previewDiv.querySelectorAll('.led-strip');
            if (!ledStrips.length) return;
            
            // Stop if already playing
            stopAnimation(id);
            
            let step = 0;
            let direction = 1;
            
            animation.isPlaying = true;
            
            animation.interval = setInterval(() => {
                // Clear all LEDs
                ledStrips.forEach(strip => {
                    strip.querySelectorAll('.led').forEach(led => {
                        led.style.backgroundColor = '#333';
                    });
                });
                
                // Apply the animation based on type
                if (animation.dimensions.height === 1) {
                    // 1D animations
                    const leds = ledStrips[0].querySelectorAll('.led');
                    
                    switch (animation.type) {
                        case 'chase':
                            const colorIndex = step % animation.colors.length;
                            const ledIndex = step % leds.length;
                            leds[ledIndex].style.backgroundColor = animation.colors[colorIndex];
                            break;
                            
                        case 'pulse':
                            const pulseStep = step % 20;
                            const opacity = pulseStep < 10 ? pulseStep / 10 : (20 - pulseStep) / 10;
                            
                            leds.forEach((led, i) => {
                                const color = animation.colors[i % animation.colors.length];
                                const rgb = hexToRgb(color);
                                led.style.backgroundColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
                            });
                            break;
                            
                        case 'rainbow':
                            leds.forEach((led, i) => {
                                const hue = ((i + step) % leds.length) * (360 / leds.length);
                                led.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
                            });
                            break;
                        
                        case 'wipe':
                            const position = step % (leds.length * 2);
                            const isForward = position < leds.length;
                            const pos = isForward ? position : leds.length * 2 - position - 1;
                            
                            for (let i = 0; i <= pos && i < leds.length; i++) {
                                const colorIdx = Math.floor(i / (leds.length / animation.colors.length)) % animation.colors.length;
                                leds[i].style.backgroundColor = animation.colors[colorIdx];
                            }
                            break;
                            
                        case 'custom':
                            if (animation.frames && animation.frames.length > 0) {
                                const frameIndex = step % animation.frames.length;
                                const frame = animation.frames[frameIndex];
                                
                                if (frame.leds) {
                                    frame.leds.forEach(ledData => {
                                        if (ledData.x >= 0 && ledData.x < leds.length) {
                                            leds[ledData.x].style.backgroundColor = ledData.color || '#ff0000';
                                        }
                                    });
                                }
                            }
                            break;
                    }
                } else {
                    // 2D animations
                    if (animation.type === 'custom' && animation.frames && animation.frames.length > 0) {
                        const frameIndex = step % animation.frames.length;
                        const frame = animation.frames[frameIndex];
                        
                        if (frame.leds) {
                            frame.leds.forEach(ledData => {
                                const x = ledData.x || 0;
                                const y = ledData.y || 0;
                                
                                if (y >= 0 && y < ledStrips.length && x >= 0) {
                                    const leds = ledStrips[y].querySelectorAll('.led');
                                    if (x < leds.length) {
                                        leds[x].style.backgroundColor = ledData.color || '#ff0000';
                                    }
                                }
                            });
                        }
                    }
                }
                
                // Update the step for next frame
                if (animation.direction === 'forward') {
                    step++;
                } else if (animation.direction === 'backward') {
                    step--;
                    if (step < 0) step = (animation.frames ? animation.frames.length - 1 : 100);
                } else if (animation.direction === 'bounce') {
                    step += direction;
                    const maxStep = animation.frames ? animation.frames.length - 1 : 100;
                    if (step >= maxStep) {
                        step = maxStep;
                        direction = -1;
                    } else if (step <= 0) {
                        step = 0;
                        direction = 1;
                    }
                }
            }, animation.speed);
        }
        
        function stopAnimation(id) {
            const animation = animationPreviews[id];
            if (!animation) return;
            
            if (animation.interval) {
                clearInterval(animation.interval);
                animation.interval = null;
            }
            
            animation.isPlaying = false;
            
            // Clear the LEDs
            const previewDiv = document.getElementById(id);
            if (previewDiv) {
                const ledStrips = previewDiv.querySelectorAll('.led-strip');
                ledStrips.forEach(strip => {
                    strip.querySelectorAll('.led').forEach(led => {
                        led.style.backgroundColor = '#333';
                    });
                });
            }
        }
        
        function selectAnimationForEditing(id) {
            const animation = animationPreviews[id];
            if (!animation) return;
            
            // Set form values
            document.getElementById('animation-name').value = animation.name;
            document.getElementById('animation-type').value = animation.type;
            document.getElementById('animation-speed').value = animation.speed;
            document.getElementById('animation-direction').value = animation.direction;
            document.getElementById('strip-length').value = animation.dimensions.length;
            document.getElementById('strip-height').value = animation.dimensions.height;
            
            // Update slider display values
            document.getElementById('strip-length-value').textContent = `${animation.dimensions.length} LEDs`;
            document.getElementById('strip-height-value').textContent = animation.dimensions.height > 1 ? 
                `${animation.dimensions.height} Rows` : `${animation.dimensions.height} Row`;
            
            // Set selected colors
            selectedColors = [...animation.colors];
            updateSelectedColors();
            
            // Set custom JSON if applicable
            if (animation.type === 'custom') {
                let jsonData = { frames: animation.frames || [] };
                document.getElementById('custom-json').value = JSON.stringify(jsonData, null, 2);
                toggleCustomJson();
            } else {
                toggleCustomJson();
            }
            
            // Set the apply button's data attribute
            document.getElementById('apply-animation').dataset.editingId = id;
        }
        
        function toggleCustomJson() {
            const animationType = document.getElementById('animation-type').value;
            const customJsonContainer = document.getElementById('custom-json-container');
            const animationParams = document.getElementById('animation-params');
            
            if (animationType === 'custom') {
                customJsonContainer.style.display = 'block';
                animationParams.style.display = 'none';
            } else {
                customJsonContainer.style.display = 'none';
                animationParams.style.display = 'block';
            }
        }
        
        function applyAnimation() {
            const id = document.getElementById('apply-animation').dataset.editingId;
            if (!id || !animationPreviews[id]) return;
            
            const animation = animationPreviews[id];
            const name = document.getElementById('animation-name').value;
            const type = document.getElementById('animation-type').value;
            const speed = parseInt(document.getElementById('animation-speed').value);
            const direction = document.getElementById('animation-direction').value;
            const length = parseInt(document.getElementById('strip-length').value);
            const height = parseInt(document.getElementById('strip-height').value);
            
            // Recreate the preview if dimensions changed
            if (animation.dimensions.length !== length || animation.dimensions.height !== height) {
                const previewDiv = document.getElementById(id);
                let stripHTML = '<div class="led-strip-container">';
                
                for (let y = 0; y < height; y++) {
                    stripHTML += '<div class="led-strip">';
                    for (let x = 0; x < length; x++) {
                        stripHTML += '<div class="led"></div>';
                    }
                    stripHTML += '</div>';
                }
                
                stripHTML += '</div>';
                
                // Replace just the LED strip container
                previewDiv.querySelector('.led-strip-container').outerHTML = stripHTML;
            }
            
            animation.name = name;
            animation.type = type;
            animation.speed = speed;
            animation.direction = direction;
            animation.dimensions = { length, height };
            animation.colors = [...selectedColors];
            
            // Update preview title
            const previewDiv = document.getElementById(id);
            previewDiv.querySelector('h3').textContent = name;
            
            // If custom animation, parse the JSON
            if (type === 'custom') {
                try {
                    const customJson = JSON.parse(document.getElementById('custom-json').value);
                    
                    // Ensure the customJson includes 'frames' property
                    if (!customJson.hasOwnProperty('frames')) {
                        throw new Error('JSON must include a "frames" property.');
                    }
                    
                    animation.frames = customJson.frames;
                } catch (error) {
                    alert('Invalid JSON format: ' + error.message);
                    return;
                }
            }
            
            // Restart animation if it was playing
            if (animation.isPlaying) {
                stopAnimation(id);
                startAnimation(id);
            }
            
            // Update JSON export
            updateJsonExport();
            updateDeployDropdown();
        }
        
        function saveAnimation() {
            // Create a new animation with the current settings
            const name = document.getElementById('animation-name').value;
            const type = document.getElementById('animation-type').value;
            const speed = parseInt(document.getElementById('animation-speed').value);
            const direction = document.getElementById('animation-direction').value;
            const length = parseInt(document.getElementById('strip-length').value);
            const height = parseInt(document.getElementById('strip-height').value);
            
            const animation = {
                name: name,
                type: type,
                speed: speed,
                direction: direction,
                dimensions: {
                    length: length,
                    height: height
                },
                colors: [...selectedColors],
                isPlaying: false,
                interval: null
            };
            
            if (type === 'custom') {
                try {
                    const customJson = JSON.parse(document.getElementById('custom-json').value);
                    
                    // Ensure the customJson includes 'frames' property
                    if (!customJson.hasOwnProperty('frames')) {
                        throw new Error('JSON must include a "frames" property.');
                    }
                    
                    animation.frames = customJson.frames;
                    
                    // If in 2D mode, attempt to convert 1D indices to 2D coordinates
                    if (height > 1) {
                        animation.frames.forEach(frame => {
                            if (frame.leds) {
                                frame.leds.forEach(ledData => {
                                    // Convert 1D indices to 2D if needed
                                    if (ledData.hasOwnProperty('index') && !ledData.hasOwnProperty('x') && !ledData.hasOwnProperty('y')) {
                                        const index = ledData.index;
                                        const x = index % length;
                                        const y = Math.floor(index / length);
                                        
                                        // Keep backward compatibility
                                        ledData.x = x;
                                        ledData.y = y;
                                        // We keep the index property for backward compatibility
                                    }
                                });
                            }
                        });
                    }
                } catch (error) {
                    alert('Invalid JSON format: ' + error.message);
                    return;
                }
            }
            
            // Add as a new animation preview
            const container = document.getElementById('animation-container');
            const id = `animation-${Date.now()}`;
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'animation-preview';
            previewDiv.id = id;
            
            let stripHTML = '<div class="led-strip-container">';
            
            for (let y = 0; y < height; y++) {
                stripHTML += '<div class="led-strip">';
                for (let x = 0; x < length; x++) {
                    stripHTML += '<div class="led"></div>';
                }
                stripHTML += '</div>';
            }
            
            stripHTML += '</div>';
            
            previewDiv.innerHTML = `
                <h3>${animation.name}</h3>
                ${stripHTML}
                <div class="controls">
                    <button class="play-pause">Play</button>
                    <button class="edit">Edit</button>
                    <button class="remove">Remove</button>
                </div>
            `;
            
            container.appendChild(previewDiv);
            
            animations.push(animation);
            animationPreviews[id] = animation;
            
            // Set up event listeners
            const playPauseBtn = previewDiv.querySelector('.play-pause');
            playPauseBtn.addEventListener('click', function() {
                if (animation.isPlaying) {
                    stopAnimation(id);
                    this.textContent = 'Play';
                } else {
                    startAnimation(id);
                    this.textContent = 'Pause';
                }
            });
            
            previewDiv.querySelector('.edit').addEventListener('click', function() {
                selectAnimationForEditing(id);
            });
            
            previewDiv.querySelector('.remove').addEventListener('click', function() {
                stopAnimation(id);
                previewDiv.remove();
                delete animationPreviews[id];
                animations = animations.filter(a => a !== animation);
                updateJsonExport();
            });
            
            // Start the animation
            startAnimation(id);
            
            // Update JSON export
            updateJsonExport();
            updateDeployDropdown();
        }
        
        function addSelectedColor(color) {
            selectedColors.push(color);
            updateSelectedColors();
        }
        
        function updateSelectedColors() {
            const selectedColorsDiv = document.getElementById('selected-colors');
            selectedColorsDiv.innerHTML = '';
            
            selectedColors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.style.display = 'inline-block';
                colorDiv.style.width = '30px';
                colorDiv.style.height = '30px';
                colorDiv.style.backgroundColor = color;
                colorDiv.style.margin = '5px';
                colorDiv.style.borderRadius = '4px';
                colorDiv.style.position = 'relative';
                colorDiv.style.cursor = 'pointer';
                
                // Add remove button
                const removeBtn = document.createElement('div');
                removeBtn.innerHTML = '×';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '-5px';
                removeBtn.style.right = '-5px';
                removeBtn.style.backgroundColor = '#ff4444';
                removeBtn.style.color = 'white';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '18px';
                removeBtn.style.height = '18px';
                removeBtn.style.textAlign = 'center';
                removeBtn.style.lineHeight = '16px';
                removeBtn.style.fontSize = '14px';
                removeBtn.style.cursor = 'pointer';
                
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedColors.splice(index, 1);
                    if (selectedColors.length === 0) {
                        selectedColors.push('#ff0000'); // Always keep at least one color
                    }
                    updateSelectedColors();
                });
                
                colorDiv.appendChild(removeBtn);
                selectedColorsDiv.appendChild(colorDiv);
            });
        }
        
        function updateJsonExport() {
            const exportData = animations.map(animation => {
                const exportAnim = {
                    id: `anim_${Date.now()}`,
                    name: animation.name,
                    type: animation.type,
                    speed: animation.speed,
                    direction: animation.direction,
                    dimensions: animation.dimensions,
                    colors: animation.colors
                };
                
                if (animation.frames) {
                    exportAnim.frames = animation.frames;
                }
                
                return exportAnim;
            });
            
            document.getElementById('json-export').value = JSON.stringify(exportData, null, 2);
        }
        
        function copyJsonToClipboard() {
            const jsonText = document.getElementById('json-export');
            jsonText.select();
            document.execCommand('copy');
            
            alert('JSON copied to clipboard!');
        }
        
        function downloadJson() {
            const jsonData = document.getElementById('json-export').value;
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'animations.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 0, b: 0 };
        }
        
        function loadAnimations() {
            fetch('/api/animation/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Clear any existing animations
                        document.getElementById('animation-container').innerHTML = '';
                        animations = [];
                        animationPreviews = {};
                        
                        // Load animations from the server
                        data.animations.forEach((anim, index) => {
                            createNewAnimationFromData(`anim-${index}`, anim);
                        });
                        
                        // Update deploy dropdown
                        updateDeployDropdown();
                    }
                })
                .catch(error => {
                    console.error('Error loading animations:', error);
                });
        }
        
        function createNewAnimationFromData(id, animData) {
            // Set defaults for missing properties
            const dims = animData.dimensions || { length: 60, height: 1 };
            const length = dims.length || 60;
            const height = dims.height || 1;
            
            // Create the HTML
            const container = document.getElementById('animation-container');
            const previewDiv = document.createElement('div');
            previewDiv.className = 'animation-preview';
            previewDiv.id = id;
            
            let stripHTML = '<div class="led-strip-container">';
            for (let y = 0; y < height; y++) {
                stripHTML += '<div class="led-strip">';
                for (let x = 0; x < length; x++) {
                    stripHTML += '<div class="led"></div>';
                }
                stripHTML += '</div>';
            }
            stripHTML += '</div>';
            
            previewDiv.innerHTML = `
                <h3>${animData.name || "Unnamed Animation"}</h3>
                ${stripHTML}
                <div class="controls">
                <button class="play-pause">Play</button>
                <button class="edit">Edit</button>
                <button class="remove">Remove</button>
                </div>
            `;
            
            container.appendChild(previewDiv);
            
            // Create animation object
            const animation = {
                name: animData.name || "Unnamed Animation",
                type: animData.type || 'chase',
                speed: animData.speed || 100,
                direction: animData.direction || 'forward',
                dimensions: dims,
                colors: animData.colors || ['#ff0000'],
                frames: animData.frames || [],
                isPlaying: false,
                interval: null
            };
            
            // Store animation
            animations.push(animation);
            animationPreviews[id] = animation;
            
            // Set up event listeners
            const playPauseBtn = previewDiv.querySelector('.play-pause');
            playPauseBtn.addEventListener('click', function() {
                if (animation.isPlaying) {
                    stopAnimation(id);
                    this.textContent = 'Play';
                } else {
                    startAnimation(id);
                    this.textContent = 'Pause';
                }
            });
            
            previewDiv.querySelector('.edit').addEventListener('click', function() {
                selectAnimationForEditing(id);
            });
            
            previewDiv.querySelector('.remove').addEventListener('click', function() {
                stopAnimation(id);
                previewDiv.remove();
                delete animationPreviews[id];
                animations = animations.filter(a => a !== animation);
                updateJsonExport();
                updateDeployDropdown();
            });
            
            // Update JSON export
            updateJsonExport();
        }
        
        function updateDeployDropdown() {
            const deployAnimSelect = document.getElementById('deploy-animation');
            deployAnimSelect.innerHTML = '';
            
            animations.forEach((anim, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = anim.name;
                deployAnimSelect.appendChild(option);
            });
        }
        
        function sendAnimationToKart() {
            const deployAnimSelect = document.getElementById('deploy-animation');
            const selectedIndex = deployAnimSelect.value;
            
            if (selectedIndex === undefined || !animations[selectedIndex]) {
                alert('Please select an animation to send');
                return;
            }
            
            const animation = animations[selectedIndex];
            const deployStatus = document.getElementById('deploy-status');
            
            deployStatus.innerHTML = '<p>Sending animation to go-kart...</p>';
            deployStatus.style.color = 'orange';
            
            // Prepare animation data for upload
            const animationData = {
                id: `anim_${Date.now()}`,
                name: animation.name,
                type: animation.type,
                speed: animation.speed,
                direction: animation.direction,
                dimensions: animation.dimensions,
                colors: animation.colors,
                frames: animation.frames || []
            };
            
            // First upload the animation to the server
            fetch('/api/animation/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ animation: animationData }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // If upload succeeded, play the animation
                    return fetch('/api/animation/play', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: data.id,
                            speed: animation.speed
                        }),
                    });
                } else {
                    throw new Error(data.message || 'Failed to upload animation');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    deployStatus.innerHTML = '<p>Animation sent successfully!</p>';
                    deployStatus.style.color = 'green';
                } else {
                    throw new Error(data.message || 'Failed to play animation');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                deployStatus.innerHTML = `<p>Error: ${error.message}</p>`;
                deployStatus.style.color = 'red';
            });
        }
    </script>
</body>
</html> 