<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-Kart Animation Editor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #61dafb;
        }
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
        }
        .animation-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .animation-preview {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            width: 100%;
            max-width: 380px;
        }
        .led-strip-container {
            background-color: #121212;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 10px;
            overflow: auto;
            max-height: 500px;
        }
        .led-strip {
            display: flex;
            margin-bottom: 4px;
            height: 30px;
        }
        .led {
            width: 20px;
            height: 20px;
            margin: 0 2px;
            border-radius: 50%;
            background-color: #333;
            transition: background-color 0.2s;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .controls button {
            background-color: #61dafb;
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .controls button:hover {
            background-color: #4fa8d1;
        }
        .editor-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .animation-editor {
            flex: 1;
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
        }
        textarea {
            width: 100%;
            height: 300px;
            background-color: #1e1e1e;
            color: #f0f0f0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
        }
        .color-picker {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
        }
        .custom-animation {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        input, select {
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
        }
        label {
            margin-bottom: 5px;
            display: inline-block;
        }
        .dimension-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .slider-container .slider-value {
            text-align: center;
            font-weight: bold;
        }
        .library-container {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .animation-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .animation-card {
            background-color: #333;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .animation-card:hover {
            background-color: #444;
            transform: translateY(-2px);
        }
        .animation-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
        }
        .animation-card p {
            margin: 4px 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .animation-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn {
            background-color: #61dafb;
            color: #000;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
        .btn-delete {
            background-color: #f55;
        }
        .btn-play {
            background-color: #5f5;
        }
        .frame-editor {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .frame-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        .frame-thumbnail {
            width: 80px;
            height: 80px;
            background-color: #333;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .frame-thumbnail.active {
            border: 2px solid #61dafb;
        }
        .frame-thumbnail .frame-number {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0,0,0,0.7);
            border-radius: 3px;
            padding: 2px 4px;
            font-size: 0.8em;
        }
        .led-grid {
            display: grid;
            grid-template-columns: repeat(60, 10px); /* 60 LEDs in a row */
            gap: 2px;
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
        }
        .led-pixel {
            width: 10px;
            height: 10px;
            background-color: #222;
            border-radius: 50%;
            cursor: pointer;
        }
        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: rgba(0, 255, 0, 0.2);
            border: 1px solid #0a0;
        }
        .error {
            background-color: rgba(255, 0, 0, 0.2);
            border: 1px solid #a00;
        }
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-links {
            display: flex;
            gap: 20px;
        }
        .nav-link {
            color: #61dafb;
            text-decoration: none;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Go-Kart Animation Editor</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/animations" class="nav-link">Animations</a>
            </div>
        </div>
        
        <div id="message-container"></div>
        
        <div class="library-container">
            <h2>Animation Library</h2>
            <div class="animation-list" id="animation-list">
                <!-- Animation cards will be loaded here -->
                <div class="loading">Loading animations...</div>
            </div>
        </div>
        
        <div class="editor-container">
            <div class="animation-editor">
                <h2>Create New Animation</h2>
                <div class="custom-animation">
                    <label for="animation-name">Animation Name:</label>
                    <input type="text" id="animation-name" placeholder="My Custom Animation">
                    
                    <label for="animation-speed">Speed (fps):</label>
                    <input type="number" id="animation-speed" min="1" max="60" value="30">
                    
                    <label for="num-frames">Number of Frames:</label>
                    <input type="number" id="num-frames" min="1" max="60" value="10">
                    
                    <div class="dimension-controls">
                        <div class="slider-container">
                            <label for="led-count">Number of LEDs:</label>
                            <input type="range" id="led-count" min="10" max="600" value="60" step="10">
                            <div class="slider-value" id="led-count-value">60 LEDs</div>
                        </div>
                    </div>
                    
                    <div class="color-picker">
                        <div class="color-option" style="background-color: #ff0000" data-color="#ff0000"></div>
                        <div class="color-option" style="background-color: #00ff00" data-color="#00ff00"></div>
                        <div class="color-option" style="background-color: #0000ff" data-color="#0000ff"></div>
                        <div class="color-option" style="background-color: #ffff00" data-color="#ffff00"></div>
                        <div class="color-option" style="background-color: #00ffff" data-color="#00ffff"></div>
                        <div class="color-option" style="background-color: #ff00ff" data-color="#ff00ff"></div>
                        <div class="color-option" style="background-color: #ffffff" data-color="#ffffff"></div>
                        <input type="color" id="custom-color" value="#ff0000">
                    </div>
                    
                    <button id="generate-animation" class="btn">Generate Empty Animation</button>
                </div>
            </div>
            
            <div class="animation-preview" id="current-animation" style="display: none;">
                <h2>Current Animation: <span id="current-animation-name">None</span></h2>
                <div class="led-strip-container">
                    <div class="led-strip" id="led-strip">
                        <!-- LEDs will be generated here -->
                    </div>
                </div>
                <div class="controls">
                    <button id="play-animation" class="btn btn-play">Play</button>
                    <button id="stop-animation" class="btn">Stop</button>
                    <button id="save-animation" class="btn">Save Animation</button>
                    <button id="upload-to-kart" class="btn">Upload to Go-Kart</button>
                </div>
                
                <div class="frame-editor">
                    <h3>Frame Editor</h3>
                    <div class="frame-list" id="frame-list">
                        <!-- Frame thumbnails will be generated here -->
                    </div>
                    <div class="led-grid" id="led-grid">
                        <!-- LED grid for editing will be generated here -->
                    </div>
                    <div class="frame-controls">
                        <button id="add-frame" class="btn">Add Frame</button>
                        <button id="delete-frame" class="btn btn-delete">Delete Frame</button>
                        <button id="duplicate-frame" class="btn">Duplicate Frame</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        const state = {
            animations: [],
            currentAnimation: null,
            currentFrame: 0,
            selectedColor: '#ff0000',
            isPlaying: false,
            playInterval: null,
            ledCount: 60
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch animations
            fetchAnimations();
            
            // Set up color picker
            setupColorPicker();
            
            // Set up LED count slider
            document.getElementById('led-count').addEventListener('input', function() {
                const value = this.value;
                document.getElementById('led-count-value').textContent = `${value} LEDs`;
                state.ledCount = parseInt(value);
            });
            
            // Set up button handlers
            document.getElementById('generate-animation').addEventListener('click', generateEmptyAnimation);
            document.getElementById('play-animation').addEventListener('click', playAnimation);
            document.getElementById('stop-animation').addEventListener('click', stopAnimation);
            document.getElementById('save-animation').addEventListener('click', saveAnimation);
            document.getElementById('upload-to-kart').addEventListener('click', uploadToKart);
            document.getElementById('add-frame').addEventListener('click', addFrame);
            document.getElementById('delete-frame').addEventListener('click', deleteFrame);
            document.getElementById('duplicate-frame').addEventListener('click', duplicateFrame);
        });
        
        // Fetch animations from the API
        function fetchAnimations() {
            fetch('/api/animations/')
                .then(response => response.json())
                .then(animations => {
                    state.animations = animations;
                    renderAnimationList();
                })
                .catch(error => {
                    showMessage('Error loading animations: ' + error.message, 'error');
                    console.error('Error loading animations:', error);
                });
        }
        
        // Render the animation list
        function renderAnimationList() {
            const listElement = document.getElementById('animation-list');
            
            if (state.animations.length === 0) {
                listElement.innerHTML = '<div>No animations found. Create one!</div>';
                return;
            }
            
            const html = state.animations.map(animation => `
                <div class="animation-card" data-id="${animation.id}">
                    <h3>${animation.name}</h3>
                    <p>Type: ${animation.type}</p>
                    <p>Frames: ${animation.frameCount}</p>
                    <div class="animation-card-actions">
                        <button class="btn" onclick="loadAnimation('${animation.id}')">Edit</button>
                        <button class="btn btn-play" onclick="playAnimationOnKart('${animation.id}')">Play on Kart</button>
                        <button class="btn btn-delete" onclick="deleteAnimation('${animation.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
            
            listElement.innerHTML = html;
        }
        
        // Set up color picker
        function setupColorPicker() {
            // Set initial color
            state.selectedColor = '#ff0000';
            
            // Set up predefined color buttons
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    state.selectedColor = this.dataset.color;
                    document.getElementById('custom-color').value = state.selectedColor;
                });
            });
            
            // Set up custom color input
            document.getElementById('custom-color').addEventListener('input', function() {
                state.selectedColor = this.value;
            });
        }
        
        // Load an animation from the server
        function loadAnimation(animationId) {
            fetch(`/api/animations/${animationId}`)
                .then(response => response.json())
                .then(animation => {
                    state.currentAnimation = animation;
                    state.currentFrame = 0;
                    document.getElementById('current-animation').style.display = 'block';
                    document.getElementById('current-animation-name').textContent = animation.name;
                    
                    // Update the form fields
                    document.getElementById('animation-name').value = animation.name;
                    document.getElementById('animation-speed').value = animation.speed || 30;
                    
                    renderAnimation();
                })
                .catch(error => {
                    showMessage('Error loading animation: ' + error.message, 'error');
                    console.error('Error loading animation:', error);
                });
        }
        
        // Generate a new empty animation
        function generateEmptyAnimation() {
            const name = document.getElementById('animation-name').value || 'Unnamed Animation';
            const speed = parseInt(document.getElementById('animation-speed').value) || 30;
            const numFrames = parseInt(document.getElementById('num-frames').value) || 10;
            
            state.currentAnimation = {
                name: name,
                type: 'custom',
                speed: speed,
                frames: []
            };
            
            // Generate empty frames
            for (let i = 0; i < numFrames; i++) {
                state.currentAnimation.frames.push({
                    leds: []
                });
            }
            
            state.currentFrame = 0;
            document.getElementById('current-animation').style.display = 'block';
            document.getElementById('current-animation-name').textContent = name;
            
            renderAnimation();
            showMessage('New animation created. Start editing!', 'success');
        }
        
        // Render the current animation
        function renderAnimation() {
            renderLedStrip();
            renderFrameList();
            renderEditorGrid();
        }
        
        // Render the LED strip for preview
        function renderLedStrip() {
            const stripElement = document.getElementById('led-strip');
            
            // Clear current LEDs
            stripElement.innerHTML = '';
            
            // Get current frame
            const frame = state.currentAnimation.frames[state.currentFrame];
            if (!frame) return;
            
            // Create a map of LED colors
            const ledColors = {};
            frame.leds.forEach(led => {
                // Support both index-based and coordinate-based formats
                const index = led.index !== undefined ? led.index : (led.x + led.y * state.ledCount);
                
                // Get color
                let color;
                if (led.color) {
                    color = led.color;
                } else if (led.r !== undefined && led.g !== undefined && led.b !== undefined) {
                    color = `rgb(${led.r}, ${led.g}, ${led.b})`;
                } else {
                    color = '#ffffff';
                }
                
                ledColors[index] = color;
            });
            
            // Create LEDs
            for (let i = 0; i < state.ledCount; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                led.style.backgroundColor = ledColors[i] || '#333';
                stripElement.appendChild(led);
            }
        }
        
        // Render the frame list
        function renderFrameList() {
            const frameListElement = document.getElementById('frame-list');
            
            // Clear current frames
            frameListElement.innerHTML = '';
            
            // Create frame thumbnails
            state.currentAnimation.frames.forEach((frame, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'frame-thumbnail';
                if (index === state.currentFrame) {
                    thumbnail.classList.add('active');
                }
                
                // Add frame number
                const frameNumber = document.createElement('div');
                frameNumber.className = 'frame-number';
                frameNumber.textContent = index + 1;
                thumbnail.appendChild(frameNumber);
                
                // Add click handler
                thumbnail.addEventListener('click', () => {
                    state.currentFrame = index;
                    renderAnimation();
                });
                
                frameListElement.appendChild(thumbnail);
            });
        }
        
        // Render the LED grid for editing
        function renderEditorGrid() {
            const gridElement = document.getElementById('led-grid');
            
            // Clear current grid
            gridElement.innerHTML = '';
            
            // Create a map of LED colors
            const ledColors = {};
            const frame = state.currentAnimation.frames[state.currentFrame];
            if (frame) {
                frame.leds.forEach(led => {
                    // Support both index-based and coordinate-based formats
                    const index = led.index !== undefined ? led.index : (led.x + led.y * state.ledCount);
                    
                    // Get color
                    let color;
                    if (led.color) {
                        color = led.color;
                    } else if (led.r !== undefined && led.g !== undefined && led.b !== undefined) {
                        color = `rgb(${led.r}, ${led.g}, ${led.b})`;
                    } else {
                        color = '#ffffff';
                    }
                    
                    ledColors[index] = color;
                });
            }
            
            // Set grid template columns based on LED count
            gridElement.style.gridTemplateColumns = `repeat(${state.ledCount}, 10px)`;
            
            // Create LEDs
            for (let i = 0; i < state.ledCount; i++) {
                const led = document.createElement('div');
                led.className = 'led-pixel';
                led.dataset.index = i;
                led.style.backgroundColor = ledColors[i] || '#222';
                
                // Add click handler
                led.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const frame = state.currentAnimation.frames[state.currentFrame];
                    
                    // Find if LED already exists
                    const ledIndex = frame.leds.findIndex(led => 
                        (led.index !== undefined && led.index === index) || 
                        (led.x !== undefined && led.y !== undefined && (led.x + led.y * state.ledCount) === index)
                    );
                    
                    if (ledIndex !== -1) {
                        // LED exists, update color or remove if clicking with same color
                        const led = frame.leds[ledIndex];
                        
                        // Check if we're clicking with the same color
                        let currentColor;
                        if (led.color) {
                            currentColor = led.color;
                        } else if (led.r !== undefined) {
                            currentColor = rgbToHex(led.r, led.g, led.b);
                        }
                        
                        if (currentColor === state.selectedColor) {
                            // Remove LED
                            frame.leds.splice(ledIndex, 1);
                        } else {
                            // Update LED color
                            if (led.color !== undefined) {
                                led.color = state.selectedColor;
                            } else {
                                const rgb = hexToRgb(state.selectedColor);
                                led.r = rgb.r;
                                led.g = rgb.g;
                                led.b = rgb.b;
                            }
                        }
                    } else {
                        // LED doesn't exist, add it
                        frame.leds.push({
                            index: index,
                            color: state.selectedColor
                        });
                    }
                    
                    // Update the display
                    renderAnimation();
                });
                
                gridElement.appendChild(led);
            }
        }
        
        // Play animation locally
        function playAnimation() {
            if (state.isPlaying) return;
            if (!state.currentAnimation || !state.currentAnimation.frames.length) return;
            
            state.isPlaying = true;
            const speed = state.currentAnimation.speed || 30;
            const frameDelay = 1000 / speed;
            
            state.playInterval = setInterval(() => {
                state.currentFrame = (state.currentFrame + 1) % state.currentAnimation.frames.length;
                renderAnimation();
            }, frameDelay);
        }
        
        // Stop animation locally
        function stopAnimation() {
            if (!state.isPlaying) return;
            
            clearInterval(state.playInterval);
            state.isPlaying = false;
        }
        
        // Add a new frame
        function addFrame() {
            if (!state.currentAnimation) return;
            
            // Add an empty frame after the current one
            state.currentAnimation.frames.splice(state.currentFrame + 1, 0, { leds: [] });
            
            // Move to the new frame
            state.currentFrame++;
            
            // Update UI
            renderAnimation();
        }
        
        // Delete the current frame
        function deleteFrame() {
            if (!state.currentAnimation || state.currentAnimation.frames.length <= 1) return;
            
            // Remove the current frame
            state.currentAnimation.frames.splice(state.currentFrame, 1);
            
            // Adjust current frame index if needed
            if (state.currentFrame >= state.currentAnimation.frames.length) {
                state.currentFrame = state.currentAnimation.frames.length - 1;
            }
            
            // Update UI
            renderAnimation();
        }
        
        // Duplicate the current frame
        function duplicateFrame() {
            if (!state.currentAnimation) return;
            
            const currentFrame = state.currentAnimation.frames[state.currentFrame];
            if (!currentFrame) return;
            
            // Create a deep copy of the current frame
            const frameCopy = JSON.parse(JSON.stringify(currentFrame));
            
            // Add it after the current frame
            state.currentAnimation.frames.splice(state.currentFrame + 1, 0, frameCopy);
            
            // Move to the new frame
            state.currentFrame++;
            
            // Update UI
            renderAnimation();
        }
        
        // Save the animation to the server
        function saveAnimation() {
            if (!state.currentAnimation) return;
            
            // Update animation properties
            state.currentAnimation.name = document.getElementById('animation-name').value || 'Unnamed Animation';
            state.currentAnimation.speed = parseInt(document.getElementById('animation-speed').value) || 30;
            
            // Send to server
            fetch('/api/animations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(state.currentAnimation)
            })
                .then(response => response.json())
                .then(data => {
                    showMessage('Animation saved successfully!', 'success');
                    // Refresh the animation list
                    fetchAnimations();
                })
                .catch(error => {
                    showMessage('Error saving animation: ' + error.message, 'error');
                    console.error('Error saving animation:', error);
                });
        }
        
        // Upload the animation to the Go-Kart
        function uploadToKart() {
            if (!state.currentAnimation) return;
            
            // First save the animation
            saveAnimation();
            
            // Then play it on the kart once we have an ID
            setTimeout(() => {
                // Find the animation in the list
                const animation = state.animations.find(a => a.name === state.currentAnimation.name);
                if (animation) {
                    playAnimationOnKart(animation.id);
                }
            }, 1000);
        }
        
        // Play an animation on the Go-Kart
        function playAnimationOnKart(animationId) {
            fetch(`/api/animations/${animationId}/play`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    showMessage(`Animation "${animationId}" playing on Go-Kart!`, 'success');
                })
                .catch(error => {
                    showMessage('Error playing animation: ' + error.message, 'error');
                    console.error('Error playing animation:', error);
                });
        }
        
        // Delete an animation
        function deleteAnimation(animationId) {
            if (!confirm('Are you sure you want to delete this animation?')) return;
            
            fetch(`/api/animations/${animationId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    showMessage('Animation deleted successfully!', 'success');
                    // Refresh the animation list
                    fetchAnimations();
                })
                .catch(error => {
                    showMessage('Error deleting animation: ' + error.message, 'error');
                    console.error('Error deleting animation:', error);
                });
        }
        
        // Utility function to show a message
        function showMessage(message, type) {
            const messageContainer = document.getElementById('message-container');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            messageContainer.appendChild(messageElement);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageElement.remove();
            }, 5000);
        }
        
        // Utility function to convert RGB to hex
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Utility function to convert hex to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 0, b: 0 };
        }
    </script>
</body>
</html> 